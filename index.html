<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>School Books Record (Live)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- Navigation -->
  <nav class="w-full bg-white shadow p-3 flex flex-wrap items-center gap-3 justify-between">
    <div class="flex items-center gap-2">
      <div class="text-xl font-bold">ðŸ“š School Books</div>
      <div class="text-sm text-gray-500 hidden md:block">Live from Google Sheets</div>
    </div>

    <div class="flex-1 max-w-2xl">
      <!-- Enlarged search input -->
      <input id="searchInput" type="text"
        placeholder="Search by book name, subject, note or class â€” try: Computing 2, English 3, 'math'..."
        class="w-full border rounded-2xl p-3 shadow-sm text-sm" />
    </div>

    <div class="flex items-center gap-2">
      <select id="classSelect" class="border rounded-lg p-2"></select>
      <button id="reloadBtn" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm">Reload Data</button>
    </div>
  </nav>

  <div class="p-4 text-sm text-gray-600">
    Showing <span id="countDisplay">0</span> records
  </div>

  <div id="cardsContainer" class="p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
    <div class="text-gray-400 text-center col-span-full">Loading data...</div>
  </div>

<script>
// ---- CLASS LIST + GID MAP ----
const SHEETS = [
  { name: "Nursery", gid: "895163057" },
  { name: "Reception", gid: "1160595593" },
  { name: "Year 1", gid: "1345706755" },
  { name: "Year 2", gid: "1936279195" },
  { name: "Year 3", gid: "316633986" },
  { name: "Year 4", gid: "1739534263" },
  { name: "Year 5", gid: "17621944" },
  { name: "Year 6", gid: "1465173656" },
  { name: "Year 7", gid: "1305449456" },
  { name: "Year 8", gid: "230300680" },
  { name: "Year 9", gid: "1869557983" },
  { name: "Question Paper", gid: "1475934526" }
];

const BASE = "https://docs.google.com/spreadsheets/d/1vorJeH359FKhsJx2umNlkMYeyOvDUZaEXpmujcbKtYU/export?format=csv&gid=";

const cardsContainer = document.getElementById("cardsContainer");
const classSelect = document.getElementById("classSelect");
const searchInput = document.getElementById("searchInput");
const reloadBtn = document.getElementById("reloadBtn");
const countDisplay = document.getElementById("countDisplay");

let allRows = [];
let filteredRows = [];

// ---- Setup Class Dropdown ----
classSelect.innerHTML = `<option>All Classes</option>` + SHEETS.map(s => `<option>${s.name}</option>`).join("");

// ---- Fetch All Sheets ----
async function fetchAllSheets() {
  cardsContainer.innerHTML = '<div class="col-span-full text-gray-400 text-center py-12">Loading data...</div>';
  try {
    const allData = await Promise.all(
      SHEETS.map(s => fetch(BASE + s.gid).then(r => r.text()))
    );

    allRows = [];

    allData.forEach((csvText, i) => {
      const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
      parsed.data.forEach(row => {
        // attach the sheet name before normalization
        row._sheet = SHEETS[i].name;
        allRows.push(normalizeRow(row));
      });
    });

    applyFilter();
  } catch (e) {
    console.error(e);
    cardsContainer.innerHTML = '<div class="col-span-full text-red-500 text-center py-12">Failed to load data.</div>';
  }
}

function normalizeRow(r) {
  return {
    SL: r["SL."] || r["SL"] || "",
    Subject: r["Subject"] || "",
    "Book Name": r["Book Name"] || r["BookName"] || r["Book"] || "",
    Quantity: r["Quentity"] || r["Quantity"] || "",
    Sale: r["Sale"] || "",
    "Tkn By Teacher": r["Tkn By Teacher"] || r["Taken By Teacher"] || r["TknByTeacher"] || "",
    Return: r["Return"] || "",
    "New Receive": r["New Recive"] || r["New Receive"] || "",
    "Total Book": r["Total Book"] || r["TotalBook"] || "",
    Note: r["Note"] || "",
    _sheet: r._sheet || ""
  };
}

// ---- Normalization for search (makes search forgiving) ----
function normalizeForSearch(input) {
  if (!input && input !== 0) return "";
  let s = String(input).toLowerCase().trim();

  // convert common unicode digits/characters to simple ascii (basic)
  // remove/replace punctuation with spaces
  s = s.replace(/[\u2018\u2019\u201C\u201D]/g, "'"); // smart quotes -> simple
  // replace any non alnum with space (keep letters and digits)
  s = s.replace(/[^a-z0-9]/g, ' ');

  // ensure boundary between letters and digits: "computing2" -> "computing 2"
  s = s.replace(/([a-z])([0-9])/g, '$1 $2').replace(/([0-9])([a-z])/g, '$1 $2');

  // collapse multiple spaces
  s = s.replace(/\s+/g, ' ').trim();

  return s;
}

// ---- Filtering ----
function applyFilter() {
  const selected = classSelect.value;
  const rawQuery = searchInput.value || "";
  const normalizedQuery = normalizeForSearch(rawQuery);
  const tokens = normalizedQuery.split(' ').filter(Boolean);

  filteredRows = allRows.filter(r => {
    // class filter
    if (selected !== "All Classes" && r._sheet !== selected) return false;

    // build a searchable text of several fields
    const searchable = normalizeForSearch(
      `${r["Book Name"]} ${r.Subject} ${r.Note} ${r._sheet} ${r["Tkn By Teacher"]} ${r.SL} ${r["Total Book"]}`
    );

    // if there's no query, keep the row (only class filter applies)
    if (!tokens.length) return true;

    // strict mode: every token must appear somewhere as substring
    const strictOk = tokens.every(t => searchable.includes(t));
    if (strictOk) return true;

    // fallback permissive mode:
    //  - check tokens against individual words (prefix match or substring)
    //  - helpful when punctuation or small typos differ
    const words = searchable.split(' ');
    const permissiveOk = tokens.every(t => words.some(w => w.startsWith(t) || w.includes(t)));
    if (permissiveOk) return true;

    // final fallback: any token is very short (1-2 chars) â€” try to match exact whole words
    const shortFallback = tokens.every(t => t.length <= 2 ? words.includes(t) : true);
    if (shortFallback) return true;

    return false;
  });

  // If nothing found and user typed something, do a "relaxed fuzzy" that allows single-token partial match
  if (!filteredRows.length && tokens.length && tokens.length <= 3) {
    const relaxed = allRows.filter(r => {
      if (selected !== "All Classes" && r._sheet !== selected) return false;
      const searchable = normalizeForSearch(
        `${r["Book Name"]} ${r.Subject} ${r.Note} ${r._sheet} ${r["Tkn By Teacher"]}`
      );
      // check if the combined query (raw) exists as substring after normalization
      return searchable.includes(normalizedQuery);
    });
    if (relaxed.length) filteredRows = relaxed;
  }

  renderCards();
}

// ---- Render Cards ----
function renderCards() {
  cardsContainer.innerHTML = "";
  countDisplay.textContent = filteredRows.length;

  if (!filteredRows.length) {
    cardsContainer.innerHTML = '<div class="col-span-full text-gray-400 text-center py-12">No records found.</div>';
    return;
  }

  // build cards
  const frag = document.createDocumentFragment();
  filteredRows.forEach(r => {
    const art = document.createElement('article');
    art.className = "bg-white rounded-2xl p-4 shadow hover:shadow-md transition text-sm";
    art.innerHTML = `
      <h3 class="text-lg font-semibold">${escapeHtml(r["Book Name"] || "â€”")}</h3>
      <p class="text-gray-500">${escapeHtml(r.Subject || "â€”")} â€¢ <b>${escapeHtml(r._sheet || "â€”")}</b></p>
      <div class="mt-3 grid grid-cols-2 gap-2">
        <p>Quantity: ${escapeHtml(r.Quantity || "â€”")}</p>
        <p>Sale: ${escapeHtml(r.Sale || "â€”")}</p>
        <p>Teacher: ${escapeHtml(r["Tkn By Teacher"] || "â€”")}</p>
        <p>Return: ${escapeHtml(r.Return || "â€”")}</p>
        <p>New Receive: ${escapeHtml(r["New Receive"] || "â€”")}</p>
        <p class="font-semibold text-blue-600">Total: ${escapeHtml(r["Total Book"] || "â€”")}</p>
      </div>
      ${r.Note ? `<p class="mt-2 text-xs text-gray-500">Note: ${escapeHtml(r.Note)}</p>` : ""}
    `;
    frag.appendChild(art);
  });
  cardsContainer.appendChild(frag);
}

// simple HTML escaper for safety
function escapeHtml(s) {
  if (s === null || s === undefined) return '';
  return String(s)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

// ---- Debounce helper so filtering doesn't run on every keystroke immediately ----
function debounce(fn, wait = 250) {
  let t;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn.apply(this, args), wait);
  };
}

// ---- Events ----
searchInput.addEventListener("input", debounce(applyFilter, 180));
classSelect.addEventListener("change", applyFilter);
reloadBtn.addEventListener("click", fetchAllSheets);

// Load on Start
fetchAllSheets();
</script>

</body>
</html>
